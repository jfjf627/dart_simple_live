name: Release Build (Self-Signed)

on:
  workflow_dispatch: # 手动触发

jobs:
  build-release-apk:
    name: Build Release APK
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      # 1. 设置 Java 环境
      - uses: actions/setup-java@v4
        with:
          distribution: "zulu"
          java-version: "17"
          cache: "gradle"

      # 2. 设置 Flutter 环境 (使用 master 分支解决依赖冲突)
      - uses: subosito/flutter-action@v2
        with:
          channel: 'master'
          cache: true

      - name: Get Dependencies
        run: |
          cd simple_live_app
          flutter pub get

      # 3. 【核心步骤】生成临时的签名证书 (Keystore)
      # 使用 keytool 生成一个名为 key.jks 的证书，密码设为 123456
      - name: Generate Keystore
        run: |
          cd simple_live_app/android/app
          keytool -genkey -v -keystore key.jks -keyalg RSA -keysize 2048 -validity 10000 -alias key -storepass 123456 -keypass 123456 -dname "CN=SelfSigned, OU=App, O=Org, L=City, S=State, C=US"

      # 4. 【核心步骤】创建 key.properties 配置文件
      # 让 Gradle 读取上面生成的证书，从而允许 Release 编译通过
      - name: Create key.properties
        run: |
          cd simple_live_app/android
          echo "storePassword=123456" > key.properties
          echo "keyPassword=123456" >> key.properties
          echo "keyAlias=key" >> key.properties
          echo "storeFile=key.jks" >> key.properties

      # 5. 编译 Release 包
      # 此时有证书了，就可以使用 --release 参数，且去掉 debug 水印
      - name: Build APK (Release)
        run: |
          cd simple_live_app
          flutter build apk --release --split-per-abi

      # 6. 上传产物
      - name: Upload APK
        uses: actions/upload-artifact@v4
        with:
          name: android-release-apk
          path: |
            simple_live_app/build/app/outputs/flutter-apk/*-release.apk
